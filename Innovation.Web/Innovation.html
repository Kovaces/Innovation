<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" href="favicon.ico">

	<title>Dashboard Template for Bootstrap</title>

	<!-- Bootstrap core CSS -->
	<link href="/Content/bootstrap.min.css" rel="stylesheet">
	<link href="/Content/Game.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

    <script src="/scripts/angular-1.3.15.min.js"></script>
    <script src="/scripts/angular-sanitize-1.3.15.min.js"></script>
</head>

<body ng-app="myapp">

    <nav class="navbar navbar-inverse">
	    <div class="container-fluid">
		    <div class="navbar-header">
			    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				    <span class="sr-only">Toggle navigation</span>
				    <span class="icon-bar"></span>
				    <span class="icon-bar"></span>
				    <span class="icon-bar"></span>
			    </button>
			    <div class="dropdown">
				    <button class="btn btn-default dropdown-toggle" type="button" id="gameMenu" data-toggle="dropdown" aria-expanded="true">
					    Innovation&nbsp;<span class="caret"></span>
				    </button>
				    <ul class="dropdown-menu" role="menu" aria-labelledby="gameMenu">
					    <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="return showCreateGame();">Create Game</a></li>
					    <li role="presentation"><a role="menuitem" tabindex="-1" href="#">My Games</a></li>
				    </ul>
			    </div>
		    </div>
		    <div id="navbar" class="navbar-collapse collapse">
			    <ul class="nav navbar-nav navbar-right">
				    <li><a href="#">Rules</a></li>
				    <li><a href="#">Profile</a></li>
			    </ul>
		    </div>
	    </div>
    </nav>
    

    <div ng-controller="mainGameController">

        <div class="createGame container-fluid modal" id="createGameModal" >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">New Game</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">Pick Players:</div>
                        <div class="row">Game Name: 
                            <input type="text" id="gameName" />
                            <input type="text" id="selectedPlayers" text="{{currentPlayerId}},"/>
                        </div>
                        <div class="container-fluid" id="createGamePlayers">
                            <button ng-repeat="p in players" ng-class="(p.Id == currentPlayerId) ? 'selected-player label' : 'unselected-player label'" onclick="selectCreateGamePlayer(this);" value="{{p.Id}}">
                                {{p.Name}} <span class="glyphicon glyphicon-user" />
                            </button>
                        </div>
                        <div class="modal-footer">
                            <div class="bottom right"><button type="button" class="btn btn-primary" onclick="return clickCreateGame();">Create!</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="gameWindow" class="mainGameWindow hidden">
    	    <div class="container-fluid">
			    <div role="tabpanel">
				    <!-- Nav tabs -->
				    <ul class="nav nav-tabs" role="tablist">
					    <li role="presentation" class="active"><a href="#playerSpace{{currentPlayerId}}" aria-controls="playerSpace{{currentPlayerId}}" role="tab" data-toggle="tab" onclick="blur(this);">Mine</a></li>
                        <li role="presentation" ng-repeat="p in game.Players | filter:{Id:'!'+currentPlayerId}">
                            <a href="#playerSpace{{p.Id}}" aria-controls="playerSpace{{p.Id}}" role="tab" data-toggle="tab" onclick="blur(this);"> {{p.Name}}</a>
					    </li>
				    </ul>
				    <div class="tab-content">
					    <div role="tabpanel" ng-class="(p.Id === currentPlayerId) ? 'tab-pane active' : 'tab-pane'" id="playerSpace{{p.Id}}" ng-repeat="p in game.Players">
                            <div class="container-fluid">
						        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-1 main" id="playerTableau{{p.Id}}">
							        <h1 class="page-header">{{p.Id === currentPlayerId ? "My (" + p.Name + ")" : p.Name}} Tableau</h1>

							        <div class="row placeholders">
								        <div class="col-xs-6 col-sm-2" id="playerTableauBlue{{p.Id}}">
									        <h4>Blue Stack</h4>
                                            <div ng-repeat="c in p.Tableau.Stacks.Blue.Cards">
									            <card-draw card="getCardById(c.Id)" />
                                            </div>
								        </div>
								        <div class="col-xs-6 col-sm-2 placeholder">
									        <h4>Green Stack</h4>
                                            <div ng-repeat="c in p.Tableau.Stacks.Green.Cards">
									            <card-draw card="getCardById(c.Id)" />
                                            </div>
								        </div>
								        <div class="col-xs-6 col-sm-2 placeholder">
									        <h4>Red Stack</h4>
                                            <div ng-repeat="c in p.Tableau.Stacks.Red.Cards">
									            <card-draw card="getCardById(c.Id)" />
                                            </div>
								        </div>
								        <div class="col-xs-6 col-sm-2 placeholder">
									        <h4>Purple Stack</h4>
                                            <div ng-repeat="c in p.Tableau.Stacks.Purple.Cards">
									            <card-draw card="getCardById(c.Id)" />
                                            </div>
								        </div>
								        <div class="col-xs-6 col-sm-2 placeholder">
									        <h4>Yellow Stack</h4>
                                            <div ng-repeat="c in p.Tableau.Stacks.Yellow.Cards">
									            <card-draw card="getCardById(c.Id)" />
                                            </div>
								        </div>
							        </div>
                                    <div class="container-fluid">
                                        <h4>Hand</h4>
                                        <div class="col-sm-9 col-md-10 col-md-offset-1 card-hand" id="playerHand{{p.Id}}">
                                            <div ng-repeat="c in p.Hand">                                        
                                                <card-draw card="getCardById(c.Id)" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
					    </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chatParent" class="chat-parent-pregame">
            <div class="chat-row2 row">
                <div id="playerListGroup" class="chat-player-list col-md-1">
                    <ul id="playerList">
                        <li class="player-item" ng-repeat="p in players">{{p.Name}}</li>
                    </ul>
                </div>
                <div id="chatMessages" class="chat-messages col-md-11" >
                    <ul id="discussion" class="chat-item" />
                </div>
            </div>
            <div class="chat-input-group row">
                <div class="col-md-11">
                    <input id="gameState" type="hidden" value=""/>
                    <input id="displayname" type="hidden" data-ng-model="currentPlayerName" />
                    <input id="message" type="text" class="chat-input" onkeypress="return chatKey(event);" />
                </div>
                <div class="col-md-1">
                    <button id="chat-send-message" class="btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

	<!-- Bootstrap core JavaScript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="Scripts/jquery-1.11.2.min.js"></script>
	<script src="Scripts/bootstrap.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.--> 
	<script src="Scripts/game.js"></script>
	<script src="Scripts/directives.js"></script>
    <script type="text/javascript">
        var chat = null;
        $(function () {
            // Declare a proxy to reference the hub. 
            chat = $.connection.innovationHub;

            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message) { receiveChat(name, '++' + message); }
            chat.client.receivePlayerList = function (message) { receivePlayerList(message); }
            chat.client.syncGameState = function (message) { syncGameState(message); }
            chat.client.setGameId = function (message) { setGameId(message); }

            chat.client.pickCard = function (cards, minSelect, maxSelect) { pickCard(cards, minSelect, maxSelect); }
            chat.client.askQuestion = function (question) { askQuestion(question); }
            chat.client.pickPlayers = function (players, minSelect, maxSelect) { pickPlayers(players, minSelect, maxSelect); }
            chat.client.askToSplay = function (colors, direction) { askToSplay(colors, direction); }

            // Get the user name and store it to prepend to messages.
            while ($('#displayname').val() == '') {
                $('#displayname').val(prompt('Enter your name:', ''));
            }
            // Set initial focus to message input box.  
            $('#message').focus();
            // Start the connection.

            $.connection.hub.disconnected(function () {
                receiveChat('CONNECTION', 'DISCONNECTED');
                if ($.connection.hub.lastError) {
                    receiveChat('SERVER', "Disconnected. Reason: " + $.connection.hub.lastError.message);
                } else
                    receiveChat('SERVER', "Disconnected. Reason unknown");
            });

            $.connection.hub.start().done(function () {
                initialize();

                $('#sendmessage').click(function () {
                    sendChatClick();
                });

                var scope = angular.element($("#gameWindow")).scope();
                scope.$apply(function () {
                    scope.currentPlayerName = $('#displayname').val();
                    currentPlayerId = '95816a87-ab2a-4058-859f-f68a11a8a8f3';  //$.connection.hub.id;
                    currentPlayerId = $.connection.hub.id;
                    scope.currentPlayerId = currentPlayerId;
                });
            });

        });

        var myApp = angular.module("myapp", []).config(function ($sceProvider) {
            $sceProvider.enabled = false;
        });

        myApp.directive('cardDraw', function () {
            return {
                restrict: 'E',
                require: '^ngCard',
                templateUrl : "/card.html",

                scope: {
                    card: '=',
                },
            }
        });

        myApp.controller("mainGameController", ['$scope', '$sce', function ($scope, $sce) {
            $scope.currentPlayerName = $("#displayname").val();
            $scope.currentPlayerId = null;

            $scope.getCardById = function (id) {
                if ($scope.cards == null) {
                    return;
                }
                for (var i = 0; i < $scope.cards.length; i++)
                    if ($scope.cards[i].Id == id) {
                        //receiveChat('CARD', 'found CARD -' + $scope.cards[i].Name + '-');

                        //if (typeof $scope.cards[i].Actions[0].htmlText === "undefined") {
                        //    for (var a = 0; a < $scope.cards[i].Actions.length; a++) {
                        //        receiveChat('CARD', 'action text ' + $scope.cards[i].Actions[a].ActionText);
                        //        $scope.cards[i].Actions[a].htmlText = $sce.trustAsHtml(' : ' + $scope.cards[i].Actions[a].ActionText);
                        //        //receiveChat('CARD', 'html text ' + $scope.cards[i].Actions[a].htmlText);
                        //    }
                        //}

                        return $scope.cards[i];
                    }
            }
        }]);

        window.addEventListener("beforeunload", function (e) {
            terminate();
        });
    </script>
</body>
</html>

